#!/bin/bash

# Цвета
YELLOW='\e[36m'
GREEN='\e[32m'
BLUE='\e[34m'
BOLD='\e[1m'
NC='\e[0m'

# Файл для хранения рекордов
RECORDS_FILE="records.txt"

# Функция для показа рекордов
show_records() {
    if [[ ! -f "$RECORDS_FILE" ]] || [[ ! -s "$RECORDS_FILE" ]]; then
        echo "Рекордов пока нет!"
        return
    fi
    
    echo
    echo -e "${YELLOW}=====ТАБЛИЦА РЕКОРДОВ=====${NC}"
    echo -e "Уровень    Попытки  Время"
    echo -e "------------------------"
    
    # Сортируем по количеству попыток (чем меньше, тем лучше)
    sort -t'|' -k2,2n "$RECORDS_FILE" | head -5 | while IFS='|' read difficulty attempts time; do
        case $difficulty in
            "1") diff_name="Низкий  ";;
            "2") diff_name="Средний ";;
            "3") diff_name="Высокий ";;
        esac
        printf "%-10s %-8d %s\n" "$diff_name" "$attempts" "${time}с"
    done
    echo -e "${YELLOW}==========================${NC}"
}

# Функция для сохранения рекорда
save_record() {
    local difficulty=$1
    local attempts=$2
    local time=$3
    echo "$difficulty|$attempts|$time" >> "$RECORDS_FILE"
}

difficult(){ # Функция для генерации числа в соответствии с выбранной сложностью
 case $(($1)) in
 "1") local num=$((RANDOM % 10 + 1));;
 "2") local num=$((RANDOM % 200 - 100));;
 "3") local num=$((RANDOM % 2001 - 1000));;
 esac
 echo $(($num))
}

test_input(){  # Проверка числа на нахождение в диапазоне
 local input=$1
 local min=$2
 local max=$3
 if [[ $input -ge $min && $input -le $max ]]; then
  return 0
 fi
 return 1
}

play_again=true

while $play_again; do
 echo
 echo -e "${BLUE}-------------${NC}${BOLD}Быки и Коровы${NC}${BLUE}--------------${NC}"  # Приветственный интерфейс
 echo -e "${GREEN}Цель игры:${NC} угадать загаданное мной число"
 echo ""
 echo "Выберите уровень сложности:"
 echo -e "1-${GREEN}Низкий${NC}(от 1 до 10)\n2-${GREEN}Средний${NC}(от -100 до 100)\n3-${GREEN}Высокий${NC}(-1000 до 1000)"

 while true; do  # Выбор сложности
  read user_choice  # Ввод пользователем (уровень сложности)
  if test_input "$user_choice" "1" "3"; then
   ai_num=$(difficult $user_choice)  # Генерация числа в соответствии с выбранной сложностью
   break
  else
   echo -n "Такой сложности нет! Выберите 1-3:"
  fi
 done

 attemps=0  # Кол-во попыток
 start_time=$(date +%s)

 echo -e "${BLUE}------${NC}Игра началась${BLUE}------${NC}"
 echo -e "(чтобы выйти введите ${GREEN}stop${NC})"
 echo
 if [[ $user_choice -eq 1 ]]; then
  min=1
  max=10
 elif [[ $user_choice -eq 2 ]]; then
  min=-100
  max=100
 else
  min=-1000
  max=1000
 fi
 
 while true; do
  echo -n "Введите число:"
  read user_try  # Попытка пользователя
  if [[ $user_try == "stop" ]]; then
   end_time=$(date +%s)
   total_time=$((end_time - start_time))
   echo "Очень жаль :c"
   echo -e "Загаданное число: ${YELLOW}$ai_num${NC}"
   break
  fi
  ((attemps++))  # +1 в счетчик попыток
  if test_input "$user_try" "$min" "$max"; then
   if [[ $user_try -lt $ai_num ]]; then
    echo -e "Загаданное число ${GREEN}больше${NC}!"
   elif [[ $user_try -gt $ai_num ]]; then
    echo -e "Загаданное число ${GREEN}меньше${NC}!"
   elif [[ $user_try -eq $ai_num ]]; then
    echo
    echo "!!! Поздравляю, вы угадали !!!"
    
    # Сохраняем рекорд
    end_time=$(date +%s)
    total_time=$((end_time - start_time))
    save_record "$user_choice" "$attemps" "$total_time"
    break
   fi
  else
   echo -e "Ваше число ${GREEN}вне${NC} диапазона :c"
  fi
 done

 end_time=$(date +%s)
 total_time=$((end_time - start_time))
 echo
 echo -e "${YELLOW}=========Статистика=========${NC}"
 echo -e "Вы играли ${YELLOW}$total_time${NC} секунд"
 echo -e "Колличество попыток: ${YELLOW}$attemps${NC}"
 echo -e "${YELLOW}============================${NC}"

 # Показываем таблицу рекордов
 show_records

 # Предложение сыграть еще раз
 echo
 echo -n "Хотите сыграть еще раз? (да/нет): "
 read answer
 if [[ $answer == "да" || $answer == "д" ||  $answer == "y" || $answer == "yes" ]]; then
  play_again=true
  echo "Начинаем новую игру!"
 else
  play_again=false
  echo "Спасибо за игру! До свидания!"
 fi
done
